package com.premierinc.sboot.demo.config;



import org.springframework.beans.factory.annotation.Autowired;

import org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder;

import org.springframework.boot.context.properties.ConfigurationProperties;

import org.springframework.context.annotation.Bean;

import org.springframework.context.annotation.Configuration;

import org.springframework.context.annotation.Primary;

import org.springframework.core.env.Environment;

import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

import org.springframework.orm.jpa.JpaTransactionManager;

import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;

import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import org.springframework.transaction.PlatformTransactionManager;



import javax.sql.DataSource;

import java.util.Properties;





@Configuration

@EnableJpaRepositories(

        basePackages = "com.premierinc.sboot.demo",

        entityManagerFactoryRef = "entityManager",

        transactionManagerRef = "transactionManager"

)

public class PersistenceConfig {

    @Autowired

    private Environment env;



    @Bean

    @Primary

    public LocalContainerEntityManagerFactoryBean entityManager() {

        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();

       em.setDataSource(dataSource());

        em.setPackagesToScan(new String[] { "com.premierinc.sboot.demo.domain"});



        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();

        em.setJpaVendorAdapter(vendorAdapter);



        Properties jpaProperties = new Properties();



        //Configures the used database dialect. This allows Hibernate to create SQL

        //that is optimized for the used database.

        jpaProperties.put("hibernate.dialect", env.getRequiredProperty("hibernate.dialect"));


        //If the value of this property is true, Hibernate writes all SQL

        //statements to the console.

        jpaProperties.put("hibernate.show_sql", env.getRequiredProperty("hibernate.show_sql"));



        //If the value of this property is true, Hibernate will format the SQL
        //that is written to the console.

        jpaProperties.put("hibernate.format_sql",   env.getRequiredProperty("hibernate.format_sql"));



        jpaProperties.put("hibernate.hbm2ddl.auto", env.getRequiredProperty("hibernate.hbm2ddl.auto"));



        em.setJpaProperties(jpaProperties);



        return em;

    }



    @Bean

    @Primary

    @ConfigurationProperties(prefix="spring.datasource")

    public DataSource dataSource() {

        return DataSourceBuilder.create().build();

    }



    @Primary

    @Bean

    public PlatformTransactionManager transactionManager() {

       JpaTransactionManager transactionManager = new JpaTransactionManager();

        transactionManager.setEntityManagerFactory(entityManager().getObject());

        return transactionManager;

    }

}
